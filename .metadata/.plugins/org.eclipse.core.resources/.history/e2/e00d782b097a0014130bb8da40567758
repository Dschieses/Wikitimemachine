package util;

import java.util.ArrayList;
import java.util.List;

import org.json.JSONException;
import org.json.JSONObject;

import entity.Category;
import entity.Page;

public class LinkApi {
	private String gplcontinue = "";
	private final String LINKS = "http://de.wikipedia.org/w/api.php?action=query&format=json&pageids=%s&generator=links&gpllimit=max&gplcontinue=%s";
	JSONObject json = null;
	
	public LinkApi()
	{
		PageApi p = new PageApi();
	}

	public boolean getGPLcontinue(JSONObject json) throws JSONException {
		if (!json.has("query-continue")) {
			gplcontinue = "undefined";
			return false;
		}
		gplcontinue = CommonFunctions.getSubJSON(json, "query-continue")
				.getJSONObject("links").getString("gplcontinue");

		return true;
	}

	public List<Page> getCategoryMembers(Page p) throws Exception {
		List<Page> list = new ArrayList<Page>();
		

		do {
			String query = String.format(LINKS, p.getPageid(),
					CommonFunctions.getEncoded(gplcontinue));
			String result = HttpUtil.getInstance().sendGet(query);
			json = CommonFunctions.getJSON(result);
			list.addAll(p.getPageInfoFromCategoryList(json));
			
		} while (getGPLcontinue());
		return list;
	}
}
